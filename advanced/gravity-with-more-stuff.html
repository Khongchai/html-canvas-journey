<!-- TODO optimize to O(logn), right now, the running time is O(n^2) -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <style>
      html,
      body {
        border: 0;
        padding: 0;
        margin: 0;
      }
    </style>
  </head>
  <body onload="draw();">
    <div><canvas id="canvas"></canvas></div>
  </body>
  <script src="../classes/particles.js"></script>
  <script src="../classes/vectors.js"></script>
  <script>
    const allElements = [];
    /*
        Gravity = inversely proportional to the distance from a body.
      */
    let canvas = document.getElementById("canvas"),
      ctx = canvas.getContext("2d"),
      width = window.innerWidth,
      height = window.innerHeight;

    canvas.width = width;
    canvas.height = height;

    //black canvas background

    const sun = new Particle(width / 2, height / 2, 0, 0),
      planet = new Particle(width / 2 + 200, height / 2, 10, 0);

    sun.mass = 20000;
    planet.mass = 100;

    allElements.push(
      { obj: sun, color: "orange" },
      { obj: planet, color: "blue" }
    );

    const draw = () => {
      //instead of clearRect, draw a trail

      ctx.fillStyle = "rgba(0, 0, 0, 0.25)";
      ctx.fillRect(0, 0, width, height);

      gravitateEverythingTowardsOneAnother();

      requestAnimationFrame(draw);
    };

    //spawn new planet on click
    window.addEventListener("click", () => {
      const newCelestialBody = new Particle(event.clientX, event.clientY, 0, 0);
      newCelestialBody.mass = Math.random() * 600;
      allElements.push({
        obj: newCelestialBody,
        color: `rgb(${Math.random() * 255}, ${Math.random() * 255}, ${
          Math.random() * 255
        })`,
      });
    });

    function gravitateEverythingTowardsOneAnother() {
      const length = allElements.length;
      for (let i = 0; i < length; i++) {
        for (let j = 0; j < length; j++) {
          if (j !== i) {
            allElements[i].obj.gravitateTo(allElements[j].obj);
          }
          allElements[i].obj.update();

          //check height
          if (
            allElements[i].obj.position.getY() > height ||
            allElements[i].obj.position.getY() < 0 ||
            allElements[i].obj.position.getX() > width ||
            allElements[i].obj.position.getX() < 0
          ) {
            allElements.splice(i, 1);
            return;
          }
        }

        ctx.beginPath();
        ctx.fillStyle = allElements[i].color;
        ctx.arc(
          allElements[i].obj.position.getX(),
          allElements[i].obj.position.getY(),
          //this looks kind of cool.
          Math.random() * 10 * Math.min(allElements[i].obj.mass * 0.01, 2),
          0,
          Math.PI * 2,
          false
        );
        ctx.fill();
        console.log(allElements.length);
      }
    }
  </script>
</html>
